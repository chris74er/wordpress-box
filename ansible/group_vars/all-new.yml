---
wordpress_host: 192.168.98.117

install_apache: true

install_oersi_plugin: true  # as long as the oersi-plugin is not available in the official wordpress-plugin-repository, we install it manually via a separate role

wp_title: wordpress-example

wp_admin_name: admin
wp_admin_email: root@wordpress.box
wp_admin_password: changeme

wp_config_reverse_proxy: true

dbname: wordpress
dbuser: wordpress
dbpassword: changeme
dbport: 3306

wordpress_installs:   # see - https://galaxy.ansible.com/oefenweb/wordpress
  - name: '{{ wp_title }}'
    dbname: '{{ dbname }}'
    dbuser: '{{ dbuser }}'
    dbpass: '{{ dbpassword }}'
    dbhost: localhost
    path: '/var/www/{{ wp_title }}'
    #document_root: '/var/www'
    url: 'http://{{ wordpress_host }}'
    title: '{{ wp_title }}'
    admin_name: '{{ wp_admin_name }}'
    admin_email: '{{ wp_admin_email }}'
    admin_password: '{{ wp_admin_password }}'
    themes:
      - name: twentytwelve
        activate: true
    plugins: []
    users: {}
    options: []
    queries: []

php_config:
  - key: upload_max_filesize
    value: 128M
  - key: post_max_size
    value: 128M

tasks:
  - name: Install necessary dependencies
    apt:
      name: 
        - curl
        - php-cli
        - php-mysql
        - php-curl
      state: present

  - name: Download wp-cli
    get_url:
      url: https://raw.githubusercontent.com/wp-cli/builds/gh-pages/phar/wp-cli.phar
      dest: /usr/local/bin/wp
      mode: '0755'

  - name: Ensure wp-cli is executable
    file:
      path: /usr/local/bin/wp
      mode: '0755'
      state: file

  - name: Verify wp-cli installation
    command: wp --info
    register: wp_cli_info

  - name: Fail if wp-cli is not installed properly
    fail:
      msg: "wp-cli was not installed properly"
    when: wp_cli_info.rc != 0

  - name: Enable WordPress Multisite
    command: wp core multisite-convert --allow-root
    args:
      chdir: /var/www/{{ wp_title }}
    when: ansible_distribution == "Ubuntu"

  - name: Update wp-config.php for Multisite
    lineinfile:
      path: /var/www/{{ wp_title }}/wp-config.php
      insertafter: "/* That's all, stop editing! Happy publishing. */"
      line: |
        define('WP_ALLOW_MULTISITE', true);
        define('MULTISITE', true);
        define('SUBDOMAIN_INSTALL', false);
        $base = '/';
        define('DOMAIN_CURRENT_SITE', '{{ wordpress_host }}');
        define('PATH_CURRENT_SITE', '/');
        define('SITE_ID_CURRENT_SITE', 1);
        define('BLOG_ID_CURRENT_SITE', 1);
    when: ansible_distribution == "Ubuntu"

  - name: Create .htaccess for Multisite
    copy:
      dest: /var/www/{{ wp_title }}/.htaccess
      content: |
        RewriteEngine On
        RewriteBase /
        RewriteRule ^index\.php$ - [L]
        # add a trailing slash to /wp-admin
        RewriteRule ^wp-admin$ wp-admin/ [R=301,L]
        RewriteCond %{REQUEST_FILENAME} -f [OR]
        RewriteCond %{REQUEST_FILENAME} -d
        RewriteRule ^ - [L]
        RewriteRule ^(wp-(content|admin|includes).*) $1 [L]
        RewriteRule ^(.*\.php)$ $1 [L]
        RewriteRule . index.php [L]
    when: ansible_distribution == "Ubuntu"

  - name: Create Subfolder Sites
    shell: |
      wp site create --slug=eins --title="Eins Multisite" --email="{{ wp_admin_email }}" --allow-root
      wp site create --slug=zwei --title="Zwei Multisite" --email="{{ wp_admin_email }}" --allow-root
      wp site create --slug=drei --title="Drei Multisite" --email="{{ wp_admin_email }}" --allow-root
    args:
      chdir: /var/www/{{ wp_title }}
    when: ansible_distribution == "Ubuntu"
